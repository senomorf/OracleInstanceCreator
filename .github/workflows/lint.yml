---
name: Lint Code Base
permissions:
  contents: read

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Node.js linters
        run: |
          npm install -g eslint@9.34.0
          npm install -g markdownlint-cli

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python linters
        run: |
          pip install djlint yamllint

      - name: Install other linters
        run: |
          # Install shellcheck
          sudo apt-get update
          sudo apt-get install -y shellcheck

          # Install actionlint using GitHub API to get correct download URL
          ACTIONLINT_VERSION=$(curl -s https://api.github.com/repos/rhymond/actionlint/releases/latest | grep -o '"tag_name": "v[^"]*' | grep -o 'v[^"]*')
          curl -L -o actionlint.tar.gz \
            "https://github.com/rhymond/actionlint/releases/download/${ACTIONLINT_VERSION}/actionlint_${ACTIONLINT_VERSION#v}_linux_amd64.tar.gz"
          tar -xzf actionlint.tar.gz
          sudo mv actionlint /usr/local/bin/
          rm actionlint.tar.gz

      - name: Run ESLint
        run: |
          if [ -f "eslint.config.js" ] || [ -f "eslint.config.mjs" ]; then
            eslint docs/dashboard/js/*.js
          else
            echo "‚ö†Ô∏è No ESLint flat config found, skipping JavaScript linting"
          fi

      - name: Run djlint
        run: |
          djlint --check docs/dashboard/*.html

      - name: Run shellcheck
        run: |
          shellcheck ./scripts/*.sh ./tests/*.sh

      - name: Run yamllint
        run: |
          if [ -f ".yamllint.yml" ]; then
            yamllint -c .yamllint.yml .github/workflows/*.yml config/*.yml
          else
            yamllint .github/workflows/*.yml config/*.yml
          fi

      - name: Run actionlint
        run: |
          actionlint .github/workflows/*.yml

      - name: Run markdownlint
        run: |
          if command -v markdownlint >/dev/null 2>&1; then
            markdownlint ./*.md docs/*.md || echo "‚ö†Ô∏è Markdown linting issues found"
          else
            echo "‚ö†Ô∏è markdownlint not available"
          fi

      - name: Lint Summary
        if: always()
        run: |
          echo "üéâ Code quality checks completed!"
          echo "Check the individual steps above for any issues."
